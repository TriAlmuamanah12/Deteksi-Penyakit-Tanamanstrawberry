<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Penyakit Strawberry</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script defer src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Deteksi Penyakit Tanaman Strawberry</h1>
        </div>
        <nav class="header-right">
            <ul>
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('deteksi') }}">Deteksi</a></li>
                <li><a href="{{ url_for('artikel') }}">Informasi Penyakit</a></li>
                <li><a href="{{ url_for('history') }}">History</a></li>
            </ul>
        </nav>
    </header>
    <main class="main-content">
        <h1>Deteksi Penyakit Strawberry</h1>
        <div class="camera-section">
            <video id="video" width="320" height="240" autoplay></video>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <div class="buttons">
                <form id="upload-form" method="post" enctype="multipart/form-data">
                    <input type="file" id="file-input" name="file" accept="image/*">
                    <input type="hidden" id="image-data" name="image-data">
                    <button id="snap">Ambil Gambar</button>
                    <button type="submit">Deteksi</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p>&copy; 2024 Deteksi Penyakit Tanaman Strawberry</p>
    </footer>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
    <script>
        // Setting up Webcam.js
        Webcam.set({
            width: 350,
            height: 350,
            image_format: 'jpeg',
            jpeg_quality: 90,
        });

        Webcam.attach('#camera', function(err) {
            if (err) {
                console.error("Webcam attach error:", err);
                alert('Webcam tidak dapat diakses: ' + err);
            } else {
                console.log("Webcam attached successfully.");
            }
        });

        // Function to take snapshot and convert to data URI
        function take_snapshot() {
            Webcam.snap(function(data_uri) {
                document.getElementById('result-img').src = data_uri;
                document.getElementById('camera').style.display = 'none';
                document.getElementById('result-img').style.display = 'block';

                // Save data URI to hidden input
                document.getElementById('snapshot-input').value = data_uri;
            });
        }

        // Convert Data URI to Blob
        function dataURItoBlob(dataURI) {
            var byteString = atob(dataURI.split(',')[1]);
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        // Handle file input change
        document.getElementById('file-input').addEventListener('change', function() {
            var file = this.files[0];
            var reader = new FileReader();

            reader.onload = function(e) {
                document.getElementById('result-img').src = e.target.result;
                document.getElementById('camera').style.display = 'none';
                document.getElementById('result-img').style.display = 'block';

                // Clear snapshot input if file is uploaded
                document.getElementById('snapshot-input').value = '';
            };

            reader.readAsDataURL(file);
        });

        // Menampilkan overlay loading saat form dikirim
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        // Menyembunyikan overlay loading
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        // Handle form submit
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            var snapshot = document.getElementById('snapshot-input').value;
            showLoading();

            if (snapshot) {
                // If snapshot is available, convert it to a file and append to the form data
                event.preventDefault();
                console.log("Submitting snapshot");

                var blob = dataURItoBlob(snapshot);
                var file = new File([blob], "snapshot.jpg", { type: "image/jpeg" });

                var formData = new FormData();
                formData.append('file', file);

                console.log('FormData snapshot:', file);

                // Send the form data to the server
                fetch('/predict', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Network response was not ok.');
                    }
                })
                .then(html => {
                    hideLoading();
                    // Load the HTML content into a new window or a div
                    document.write(html);
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error:', error);
                    alert('Prediction failed: ' + error.message);
                });
            } else {
                console.log("Submitting file upload");
            }
        });
    </script>
</body>
</html>
